<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cmchen的网盘</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- highlight.js for code preview -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme" />
</head>
<body>

<!-- ════════════════════════════ SETUP MODAL ════════════════════════════ -->
<div id="setup-modal" class="modal-overlay">
  <div class="modal-box setup-box">
    <div class="setup-logo">
      <i class="fa-solid fa-cloud"></i>
      <span>cmchen的网盘</span>
    </div>
    <h2>配置存储</h2>
    <p class="setup-desc">本网盘使用 GitHub 仓库作为存储后端，请填写以下信息完成初始化。</p>

    <div class="setup-tip-box">
      <i class="fa-solid fa-circle-info"></i>
      <div>
        <b>仓库所有者</b> 即 GitHub 用户名，<b>仓库名称</b> 即存放文件的仓库名。<br>
        如当前网址是 <code>shi-tou1234.github.io/pan</code>，则所有者填 <code>shi-tou1234</code>，仓库填 <code>pan</code>。
      </div>
    </div>

    <div class="form-group">
      <label>GitHub Token <span class="tip">（Classic token，需勾选 repo 权限）</span></label>
      <div class="input-wrap">
        <input type="password" id="cfg-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off" />
        <button class="btn-toggle-pwd" onclick="togglePwd('cfg-token')"><i class="fa-regular fa-eye"></i></button>
      </div>
    </div>
    <div class="form-group">
      <label>仓库所有者 <span class="tip">（GitHub 用户名）</span></label>
      <input type="text" id="cfg-owner" placeholder="your-username" autocomplete="off" spellcheck="false" />
    </div>
    <div class="form-group">
      <label>仓库名称 <span class="tip">（区分大小写）</span></label>
      <input type="text" id="cfg-repo" placeholder="pan" autocomplete="off" spellcheck="false" />
      <div class="field-hint" id="repo-hint" style="display:none"></div>
    </div>
    <div class="form-group">
      <label>分支 <span class="tip">（默认 main）</span></label>
      <input type="text" id="cfg-branch" placeholder="main" value="main" />
    </div>
    <div class="form-group">
      <label>存储目录 <span class="tip">（文件存放到仓库的哪个目录，默认 files）</span></label>
      <input type="text" id="cfg-dir" placeholder="files" value="files" />
    </div>
    <div class="form-group">
      <label class="select-all-wrap" style="margin-top:8px">
        <input type="checkbox" id="cfg-proxy" checked /> 开启 CDN 加速（仅限公开仓库，极大提升预览速度）
      </label>
    </div>
    <div id="setup-error" class="setup-error" style="display:none"></div>
    <div class="setup-actions">
      <button class="btn btn-primary btn-full" id="setup-save-btn" onclick="saveConfig()">
        <i class="fa-solid fa-check"></i> 保存并连接
      </button>
    </div>
    <a class="setup-help" href="https://github.com/settings/tokens/new?scopes=repo&description=Pan%E7%BD%91%E7%9B%98" target="_blank">
      <i class="fa-solid fa-key"></i> 生成 GitHub Classic Token（勾选 repo）
    </a>
  </div>
</div>

<!-- ════════════════════════════ MAIN APP ════════════════════════════ -->
<div id="app" class="app" style="display:none">

  <!-- ── SIDEBAR ── -->
  <aside class="sidebar">
    <div class="sidebar-logo" onclick="goHome()">
      <i class="fa-solid fa-cloud"></i>
      <span>cmchen的网盘</span>
    </div>

    <div class="sidebar-upload">
      <button class="btn btn-upload" onclick="triggerUpload()">
        <i class="fa-solid fa-plus"></i> 上传文件
      </button>
      <button class="btn btn-upload-folder" onclick="triggerFolderUpload()" title="上传文件夹">
        <i class="fa-solid fa-folder-plus"></i>
      </button>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section-title">文件</div>
      <a class="nav-item active" data-cat="all" onclick="switchCategory('all')">
        <i class="fa-solid fa-layer-group"></i> 全部文件
      </a>
      <a class="nav-item" data-cat="image" onclick="switchCategory('image')">
        <i class="fa-solid fa-image"></i> 图片
      </a>
      <a class="nav-item" data-cat="video" onclick="switchCategory('video')">
        <i class="fa-solid fa-film"></i> 视频
      </a>
      <a class="nav-item" data-cat="audio" onclick="switchCategory('audio')">
        <i class="fa-solid fa-music"></i> 音乐
      </a>
      <a class="nav-item" data-cat="doc" onclick="switchCategory('doc')">
        <i class="fa-solid fa-file-lines"></i> 文档
      </a>
      <a class="nav-item" data-cat="archive" onclick="switchCategory('archive')">
        <i class="fa-solid fa-file-zipper"></i> 压缩包
      </a>
      <a class="nav-item" data-cat="other" onclick="switchCategory('other')">
        <i class="fa-solid fa-ellipsis"></i> 其他
      </a>
    </nav>

    <div class="sidebar-bottom">
      <div class="storage-info">
        <div class="storage-label">
          <span>仓库存储</span>
          <span id="storage-size">-- MB</span>
        </div>
        <div class="storage-bar"><div class="storage-fill" id="storage-fill" style="width:0%"></div></div>
      </div>
      <button class="btn-settings" onclick="openSettings()"><i class="fa-solid fa-gear"></i> 设置</button>
    </div>
  </aside>

  <!-- ── MAIN ── -->
  <main class="main">

    <!-- Top bar -->
    <div class="topbar">
      <div class="topbar-left">
        <div class="breadcrumb" id="breadcrumb">
          <span class="bc-item bc-home" onclick="goHome()"><i class="fa-solid fa-house"></i> 全部文件</span>
        </div>
      </div>
      <div class="topbar-right">
        <div class="search-wrap">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" id="search-input" placeholder="搜索文件..." oninput="onSearch(this.value)" />
          <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <button class="btn-icon" title="新建文件夹" onclick="createFolderPrompt()"><i class="fa-solid fa-folder-plus"></i></button>
        <button class="btn-icon" id="view-btn" title="切换视图" onclick="toggleView()"><i class="fa-solid fa-grip"></i></button>
        <button class="btn-icon" title="刷新" onclick="loadFiles()"><i class="fa-solid fa-rotate-right"></i></button>
      </div>
    </div>

    <!-- Sort bar -->
    <div class="sortbar" id="sortbar">
      <label class="select-all-wrap">
        <input type="checkbox" id="select-all-cb" onchange="toggleSelectAll(this.checked)" /> 全选
      </label>
      <div class="sort-btns">
        <button class="sort-btn active" data-sort="name" onclick="sortBy('name')">名称 <i class="fa-solid fa-sort"></i></button>
        <button class="sort-btn" data-sort="size" onclick="sortBy('size')">大小 <i class="fa-solid fa-sort"></i></button>
        <button class="sort-btn" data-sort="time" onclick="sortBy('time')">时间 <i class="fa-solid fa-sort"></i></button>
      </div>
      <div class="batch-actions" id="batch-actions" style="display:none">
        <button class="btn btn-sm btn-danger" onclick="deleteSelected()"><i class="fa-solid fa-trash"></i> 删除</button>
        <button class="btn btn-sm" onclick="downloadSelected()"><i class="fa-solid fa-download"></i> 下载</button>
      </div>
    </div>

    <!-- Drop zone hint -->
    <div class="drop-hint" id="drop-hint">
      <i class="fa-solid fa-cloud-arrow-up"></i>
      <p>拖放文件到此处上传</p>
    </div>

    <!-- File grid / list -->
    <div class="file-area" id="file-area">
      <div class="loading-state" id="loading-state">
        <div class="spinner"></div>
        <p>加载中...</p>
      </div>
      <div class="empty-state" id="empty-state" style="display:none">
        <i class="fa-solid fa-folder-open"></i>
        <p>此处暂无文件</p>
        <button class="btn btn-primary" onclick="triggerUpload()"><i class="fa-solid fa-plus"></i> 上传文件</button>
      </div>
      <div class="file-grid" id="file-grid"></div>
    </div>

    <!-- Upload progress -->
    <div class="upload-panel" id="upload-panel" style="display:none">
      <div class="upload-panel-header">
        <span><i class="fa-solid fa-cloud-arrow-up"></i> 上传任务</span>
        <button onclick="toggleUploadPanel()"><i class="fa-solid fa-chevron-down" id="upload-panel-icon"></i></button>
      </div>
      <div class="upload-list" id="upload-list"></div>
    </div>

  </main>
</div>

<!-- ════════════════════════════ PREVIEW MODAL ════════════════════════════ -->
<div class="modal-overlay" id="preview-modal" style="display:none" onclick="closePreviewOnBg(event)">
  <div class="preview-container" id="preview-container">
    <div class="preview-header">
      <div class="preview-title" id="preview-title"></div>
      <div class="preview-actions">
        <button class="btn-icon-white" id="prev-file-btn" onclick="previewNav(-1)" title="上一个"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="btn-icon-white" id="next-file-btn" onclick="previewNav(1)" title="下一个"><i class="fa-solid fa-chevron-right"></i></button>
        <button class="btn-icon-white" onclick="downloadCurrentPreview()" title="下载"><i class="fa-solid fa-download"></i></button>
        <button class="btn-icon-white" onclick="closePreview()" title="关闭"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="preview-body" id="preview-body">
      <div class="preview-loading"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- ════════════════════════════ CONTEXT MENU ════════════════════════════ -->
<div class="context-menu" id="context-menu" style="display:none">
  <div class="ctx-item" onclick="ctxOpen()"><i class="fa-solid fa-eye"></i> 预览/打开</div>
  <div class="ctx-item" onclick="ctxDownload()"><i class="fa-solid fa-download"></i> 下载</div>
  <div class="ctx-item" onclick="ctxRename()"><i class="fa-solid fa-pen"></i> 重命名</div>
  <div class="ctx-item" onclick="ctxCopyLink()"><i class="fa-solid fa-link"></i> 复制链接</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item ctx-danger" onclick="ctxDelete()"><i class="fa-solid fa-trash"></i> 删除</div>
</div>

<!-- ════════════════════════════ NEW FOLDER MODAL ════════════════════════════ -->
<div class="modal-overlay" id="folder-modal" style="display:none">
  <div class="modal-box sm-box">
    <h3>新建文件夹</h3>
    <input type="text" id="folder-name-input" placeholder="文件夹名称" class="full-input" onkeydown="if(event.key==='Enter')confirmCreateFolder()" />
    <div class="modal-actions">
      <button class="btn" onclick="closeFolderModal()">取消</button>
      <button class="btn btn-primary" onclick="confirmCreateFolder()">创建</button>
    </div>
  </div>
</div>

<!-- ════════════════════════════ RENAME MODAL ════════════════════════════ -->
<div class="modal-overlay" id="rename-modal" style="display:none">
  <div class="modal-box sm-box">
    <h3>重命名</h3>
    <input type="text" id="rename-input" placeholder="新名称" class="full-input" onkeydown="if(event.key==='Enter')confirmRename()" />
    <div class="modal-actions">
      <button class="btn" onclick="closeRenameModal()">取消</button>
      <button class="btn btn-primary" onclick="confirmRename()">确认</button>
    </div>
  </div>
</div>

<!-- ════════════════════════════ SETTINGS MODAL ════════════════════════════ -->
<div class="modal-overlay" id="settings-modal" style="display:none">
  <div class="modal-box setup-box">
    <div class="modal-header-row">
      <h3>设置</h3>
      <button class="btn-icon" onclick="closeSettings()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="form-group">
      <label>GitHub Token</label>
      <div class="input-wrap">
        <input type="password" id="s-token" autocomplete="off" />
        <button class="btn-toggle-pwd" onclick="togglePwd('s-token')"><i class="fa-regular fa-eye"></i></button>
      </div>
    </div>
    <div class="form-group">
      <label>仓库所有者</label>
      <input type="text" id="s-owner" />
    </div>
    <div class="form-group">
      <label>仓库名称</label>
      <input type="text" id="s-repo" />
    </div>
    <div class="form-group">
      <label>分支</label>
      <input type="text" id="s-branch" />
    </div>
    <div class="form-group">
      <label>存储目录</label>
      <input type="text" id="s-dir" />
    </div>
    <div class="form-group">
      <label class="select-all-wrap">
        <input type="checkbox" id="s-proxy" /> 开启 CDN 加速（仅限公开仓库）
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeSettings()">取消</button>
      <button class="btn btn-danger" onclick="clearConfig()">清除配置</button>
      <button class="btn btn-primary" onclick="saveSettings()">保存</button>
    </div>
  </div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="file-input" multiple style="display:none" onchange="handleFileSelect(this.files)" />
<input type="file" id="folder-input" webkitdirectory multiple style="display:none" onchange="handleFileSelect(this.files)" />

<!-- Toast -->
<div id="toast-container"></div>

<!-- Scripts (CDN libraries) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- App scripts -->
<script src="js/api.js"></script>
<script src="js/preview.js"></script>
<script src="js/app.js"></script>
</body>
</html>
